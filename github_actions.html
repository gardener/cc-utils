

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitHub-Actions &mdash; cc-utils  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            cc-utils
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">Pipeline Definition</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline_job.html">Pipeline Job</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline_step.html">Pipeline Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="traits.html">Pipeline Definition Traits</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes.html">Release Notes Process</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">cc-utils</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">GitHub-Actions</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/github_actions.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="github-actions">
<h1>GitHub-Actions<a class="headerlink" href="#github-actions" title="Link to this heading"></a></h1>
<p><a class="reference external" href="https://github.com/features/actions">GitHub-Actions</a> is a managed CI/CD offering integrated
into GitHub. For standardisation and re-use within Gardener-Project, we maintain some re-usable
Actions and Workflows (kept in
<a class="reference external" href="https://github.com/gardener/cc-utils/tree/master/.github">cc-utils repository</a>). Those offer
functionality similar to Concourse-Pipeline-Template. This includes integration with
<a class="reference external" href="https://ocm.software">OCM (Open Component Model)</a>, as well as release (notes) handling.</p>
<p>To improve security posture, we make use of trustbased-authentication, and avoid usage of static
credentials where possible.</p>
<section id="migration-from-concourse-pipelines">
<h2>Migration from Concourse-Pipelines<a class="headerlink" href="#migration-from-concourse-pipelines" title="Link to this heading"></a></h2>
<p>The default pipeline setup for Concourse-Pipelines consists of three pipelines:</p>
<ul class="simple">
<li><p>head-update (run for certain branches - typically default + release-branches)</p></li>
<li><p>pull-request (run for pullrequests)</p></li>
<li><p>release (manually triggered to publish new releases)</p></li>
</ul>
<p>This is migrated to workflows of the following layout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">github</span><span class="o">/</span><span class="n">workflows</span><span class="o">/</span><span class="n">build</span><span class="o">.</span><span class="n">yaml</span>       <span class="c1"># shared; called by other workflows</span>
<span class="o">.</span><span class="n">github</span><span class="o">/</span><span class="n">workflows</span><span class="o">/</span><span class="n">release</span><span class="o">.</span><span class="n">yaml</span>     <span class="c1"># for manually triggering releases</span>
<span class="o">.</span><span class="n">github</span><span class="o">/</span><span class="n">workflows</span><span class="o">/</span><span class="n">non</span><span class="o">-</span><span class="n">release</span><span class="o">.</span><span class="n">yaml</span> <span class="c1"># for triggering upon head-updates / pullrequests</span>
</pre></div>
</div>
<section id="branch-protection-rulesets">
<h3>Branch-Protection -&gt; Rulesets<a class="headerlink" href="#branch-protection-rulesets" title="Link to this heading"></a></h3>
<p>Most repositories use branch-protections to forbid directly pushing to a branch. Some pipelines,
most prominently release-pipelines (which push release- and “bump”-commits), need to circumvent
those rules. As we want to avoid using static credentials (for Service-Accounts w/
owner-permissions), we use a <a class="reference external" href="https://github.com/apps/gardener-github-actions">GitHub-App</a>
for granting such permissions more fine-granular.</p>
<p>However, as discussed <a class="reference external" href="https://github.com/orgs/community/discussions/13836">here</a>, it is only
possible to grant exceptions (or “bypassers”, as GitHub Rulesets call them) to branch protections
if using the more modern <code class="code docutils literal notranslate"><span class="pre">Rulesets</span></code>. Hence, as part of migration to GitHub-Actions, it is necessary
to migrate branch-protections to rulesets.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is important to no longer use “classical” branch protections after migration of
release-pipeline to GitHub-Actions. Configure any protection-rules using the more modern
<code class="code docutils literal notranslate"><span class="pre">Rulesets</span></code>, instead. The latter are a superset to branch-protections w.r.t. configuration
options.</p>
</div>
</section>
</section>
<section id="pull-requests-from-forked-repositories">
<h2>Pull-Requests from forked Repositories<a class="headerlink" href="#pull-requests-from-forked-repositories" title="Link to this heading"></a></h2>
<p>To mitigate harm from malicious Pull-Requests, GitHub-Actions-Workflow-Runs are run with restricted
privileges. If using <code class="code docutils literal notranslate"><span class="pre">pull_request</span></code> as pipeline-trigger, corresponding workflow-runs will only have
readonly-access to target-repository. This prevents such runs to push build artefacts, such as
OCI-Images or Helmcharts (to OCI-Registries).</p>
<p>As an alternative, there is the <code class="code docutils literal notranslate"><span class="pre">pull_request_target</span></code> trigger, which does not have this limitation.
However, by default, thus-triggered runs will be based on the pull-request’s target repository,
i.e. the actual changes proposed by a Pull-Request will not be visible to the pipeline-run.</p>
<p>For the latter case, there is the
<a class="reference external" href="https://github.com/gardener/cc-utils/tree/master/.github/actions/trusted-checkout">trusted-checkout</a>
action, which will circumvent this limitation, and explicitly checkout commits from trusted
pullrequests. Pullrequests are considered to be trusted, if</p>
<ul class="simple">
<li><p>the fork’s owner is the same as the target-repository (i.e. a fork within the same organisation)</p></li>
</ul>
<p>OR
- the pullrequest-author is either of:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">COLLABORATOR</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">CONTRIBUTOR</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">MEMBER</span></code> (org-member)</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">OWNER</span></code> (repository-owner)</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>the pullrequest has a certain label (default: <code class="code docutils literal notranslate"><span class="pre">reviewed/ok-to-test</span></code>) set</p></li>
</ul>
<p>The preferred approach (because it will also work for first-time contributors) is using
“label-based trust”.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For pullrequests that are not considered to be trusted, the workflow-run will still be executed.
However, re-usable workflows from cc-utils will not attempt to push build-results, nor will
the run be based on the changes from the pullrequest, which may be unintuitive.</p>
<p>In such cases, a warning is emitted into the pipeline-run’s summary.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are the following “autor-associations” a pullrequest author can have:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>association</p></th>
<th class="head"><p>explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>COLLABORATOR</p></td>
<td><p>Author has been invited to collaborate on the repository</p></td>
</tr>
<tr class="row-odd"><td><p>CONTRIBUTOR</p></td>
<td><p>Author has previously committed to the repository</p></td>
</tr>
<tr class="row-even"><td><p>FIRST_TIMER</p></td>
<td><p>Author has not previously committed to GitHub</p></td>
</tr>
<tr class="row-odd"><td><p>FIRST_TIME_CONTRIBUTOR</p></td>
<td><p>Author has not previously committed to the repository</p></td>
</tr>
<tr class="row-even"><td><p>MANNEQUIN</p></td>
<td><p>Author is a placeholder for an unclaimed user</p></td>
</tr>
<tr class="row-odd"><td><p>MEMBER</p></td>
<td><p>Author is a member of the organization that owns the repository</p></td>
</tr>
<tr class="row-even"><td><p>NONE</p></td>
<td><p>Author has no association with the repository</p></td>
</tr>
<tr class="row-odd"><td><p>OWNER</p></td>
<td><p>Author is the owner of the repository.</p></td>
</tr>
</tbody>
</table>
</div>
<section id="when-to-use-what">
<h3>When to use what<a class="headerlink" href="#when-to-use-what" title="Link to this heading"></a></h3>
<p>If a workflow does not need to publish changes from pullrequests, use <code class="code docutils literal notranslate"><span class="pre">on.pull_request</span></code>.
Otherwise, use <code class="code docutils literal notranslate"><span class="pre">on.pull_request_target</span></code>. In this case, consistently use <code class="code docutils literal notranslate"><span class="pre">trusted-checkout</span></code> instead
of <code class="code docutils literal notranslate"><span class="pre">actions/checkout</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If using <code class="code docutils literal notranslate"><span class="pre">pull_request_target</span></code>, special care needs to be done to catch malicious changes,
especially such changes that are done in buildscripts.</p>
</div>
</section>
<section id="example-configuration-for-label-based-trust">
<h3>Example configuration for label-based trust<a class="headerlink" href="#example-configuration-for-label-based-trust" title="Link to this heading"></a></h3>
<p>If privileged pipelines are needed, use the following event-trigger:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">on</span><span class="p">:</span>
<span class="w">   </span><span class="nt">pull_request_target</span><span class="p">:</span>
<span class="w">      </span><span class="nt">types</span><span class="p">:</span>
<span class="w">         </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">labeled</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">   </span><span class="nt">example</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># the left condition (!= labeled) is only needed, if different triggers (e.g. push) are</span>
<span class="w">      </span><span class="c1"># used.</span>
<span class="w">      </span><span class="c1"># it is important to add the explicit check for label&#39;s name to prevent accidental</span>
<span class="w">      </span><span class="c1"># triggering (e.g. from gardener-robot setting initial set of labels)</span>
<span class="w">      </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ github.event.action != &#39;labeled&#39; || github.event.label.name == &#39;revieved/ok-to-test&#39; }}</span>
<span class="w">      </span><span class="nt">permissions</span><span class="p">:</span>
<span class="w">         </span><span class="nt">pull-requests</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span><span class="w"> </span><span class="c1"># needed so trusted-checkout can remove trusted-label</span>
<span class="w">                              </span><span class="c1"># caveat: also needs to be set for all called workflows</span>
<span class="w">                              </span><span class="c1"># that use trusted-checkout (action)</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
<p>The following workflow can be added for convenience:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pullrequest-trust-helper.yaml</span>
<span class="nt">on</span><span class="p">:</span>
<span class="w">   </span><span class="nt">pull_request_target</span><span class="p">:</span>
<span class="w">      </span><span class="nt">types</span><span class="p">:</span>
<span class="w">         </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opened</span>
<span class="w">         </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">edited</span>
<span class="w">         </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reopened</span>
<span class="w">         </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synchronize</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">   </span><span class="nt">pullrequest-trusted-helper</span><span class="p">:</span>
<span class="w">      </span><span class="nt">permissions</span><span class="p">:</span>
<span class="w">         </span><span class="nt">pull-requests</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">write</span>
<span class="w">      </span><span class="nt">secrets</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inherit</span><span class="w"> </span><span class="c1"># access to `GitHub-Actions`-App is needed to read teams</span>
<span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gardener/cc-utils/.github/workflows/pullrequest-trust-helper@master</span>
<span class="w">      </span><span class="nt">with</span><span class="p">:</span>
<span class="w">         </span><span class="c1"># members will be trusted (-&gt; get okay-to-test-label automatically)</span>
<span class="w">         </span><span class="nt">trusted-teams</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;first-team,second-team&#39;</span>
</pre></div>
</div>
</section>
<section id="caveats">
<h3>Caveats<a class="headerlink" href="#caveats" title="Link to this heading"></a></h3>
<p>Regardless which of <code class="code docutils literal notranslate"><span class="pre">on.pull_request</span></code> or <code class="code docutils literal notranslate"><span class="pre">on.pull_request_target</span></code> is used, workflow-runs will
always be based on target-repository’s local workflow- and actions-definitions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be sure to grant <code class="code docutils literal notranslate"><span class="pre">pull-requests:</span> <span class="pre">write</span></code>-permission to all workflows called from
pull_request_target-event (this is needed so trusted-checkout action is able to remove
trusted-label).</p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2020, SAP SE or an SAP affiliate company..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>