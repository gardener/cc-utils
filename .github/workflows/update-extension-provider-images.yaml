#
# SPDX-FileCopyrightText: 2025 SAP SE or an SAP affiliate company and Gardener contributors
#
# SPDX-License-Identifier: Apache-2.0
#
name: Reusable Image Version Updater

on:
  workflow_call:
    inputs:
      branch-name:
        description: 'The name of the branch for the pull request.'
        required: false
        type: string
        default: 'chore/auto-update-images'

jobs:
  update-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Run image update action
        uses: ./.github/actions/update-extension-provider-images

      - name: Read release notes file
        id: release_notes
        continue-on-error: true
        run: |
          notes=$(cat release-notes.md)
          notes="${notes//'%'/'%25'}"
          notes="${notes//$'\n'/'%0A'}"
          notes="${notes//$'\r'/'%0D'}"
          echo "notes_content=${notes}" >> $GITHUB_OUTPUT

      - name: Create GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2.1.1
        with:
          app-id: ${{ vars.GARDENER_GITHUB_ACTIONS_APP_ID }}
          private-key: ${{ secrets.GARDENER_GITHUB_ACTIONS_PRIVATE_KEY }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6.0.5
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: 'Chore: Auto-update image versions'
          title: 'ü§ñ Chore: Auto-update container image versions'
          body: |
            This PR was auto-generated by the 'Auto-update Image Versions' GitHub Action.

            It contains updates to container image versions in `${{ inputs.images-yaml-path }}`.

            ---

            ### üìù Release Notes

            ${{ steps.release_notes.outputs.notes_content }}

            ---

            ### ‚úÖ Reviewer Checklist

            - [ ] I have reviewed the release notes for all updated components.
            - [ ] I have verified that no breaking changes require modifications to our Helm charts or code.
            - [ ] I have confirmed that the changes in `${{ inputs.images-yaml-path }}` are correct.
          branch: ${{ inputs.branch-name }}
          labels: "chore, dependencies"

      - name: Clean up release notes file
        if: always()
        run: rm -f release-notes.md
