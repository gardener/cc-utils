name: Release

# description: |
#   An opinionated re-usable workflow for Gardener-Release-Pipelines. Release-Pipelines based on
#   this workflow:
#
#     - publish OCM-Component-Descriptors
#     - push tags, GitHub-Releases, and "bump-commits"
#     - collect release-notes (based on `gardener/cc-utils/.github/actions/release-notes` action)
#
#   Note: This workflow assumes there is a GitHub-App granting the privileges to "write contents" (
#   for "git-push"), in addition to declared privileges for GitHub-Action-Token. Said application is
#   also required to be added to `bypassers` for any configured branch-protection-rules (or, to be
#   more precise: rulesets, as "classic" branch-protections do not allow this).
#
#   The GitHub-App's ID is read from `vars.GARDENER_GITHUB_ACTIONS_APP_ID` (org-variable), and its
#   private-key needs to be passed in as secret from `secrets.GARDENER_GITHUB_ACTIONS_PRIVATE_KEY`).

on:
  workflow_call:
    secrets:
      github-app-secret-key:
        required: false
        description: |
          The secret-key for the `Gardener-GitHub-App` (`vars.GARDENER_GITHUB_ACTIONS_APP_ID`)
          If not passed (in which case calling workflows need to set `secrets: inherit`), defaults
          to `secrets.GARDENER_GITHUB_ACTIONS_PRIVATE_KEY`.
    inputs:
      component-descriptor:
        required: false
        type: string
        description: |
          A base-component-descriptor, as output from `base-component-descriptor` action.
          Additional Component-Descriptor-Fragments as exported from the `export-ocm-fragments`
          action will be merged into it (i.e. callers do not need to take care of this).

          If not passed, an artefact named `base-component-descriptor` will be assumed to
          exist, and used as default / fallback.
      on-validation-errors:
        default: fail
        type: string
        description: |
          How to behave in case of validation-errors. Allowed values are:
          - fail     # abort release
          - continue # ignore and create release (if possible)

          Validation can be customised using `ocm-validation-cfg` input (currently, only
          OCM-Component-Descriptor validation is implemented).
      release-commit-objects:
        required: false
        type: string
        description: |
          The release-commit (created from build-job) to publish. The expected format matches the
          one emitted by the `capture-commit` action; i.e. the value is expected to be a base64
          encoded TARchive containing all objects belonging to the commit, as taken from `.git`
          directory after commit was created.

          If not passed, the action will fallback to expecting the commit-objects having been
          uploaded into an artefact named `release-commit-objects` (which the `prepare.yaml`)
          workflow does by default.
      release-commit-target:
        required: false
        default: branch
        type: string
        description: |
          Where the relase-commit should be published to. Passed to `release` action's equally-named
          input. Allowed values are:
            - branch # will push to same branch the workflow was run for
            - tag # will push release-commit to release-tag
      next-version:
        required: false
        default: bump-minor
        type: string
        description: |
          How the next version (from bump-commit) should be calculated. Will be passed to `version`
          action. (some) allowed values are:
            - automatic (use `.ocm/branch-info.yaml` to determine the version part to bump)
            - bump-major
            - bump-minor
            - bump-patch
      next-version-callback-action-path:
        required: false
        type: string
        description: |
          the path to a local action (relative to repository-root) that should be called during
          creation of "bump-commit"
          passed to `gardener/cc-utils/.github/actions/version` as callback-action-path input.
      slack-channel-id:
        required: false
        type: string
        description: |
          If passed, release-notes will be posted into slack-channel w/ specified ID.

          Use `release-notes`-output if more control is desired.

          Note: see `slack-token` for authentication options.
      slack-token:
        required: false
        type: string
        description: |
          The auth-token to use to authenticate against slack. Only needed if `slack-channel-id` is
          passed. For convenience, defaults to `secrets.SLACK_APP_TOKEN_GARDENER_CICD` (calling
          workflows must set `secrets: inherit` for this to work.
      github-release-notes-audiences:
        required: false
        type: string
        default: dependency,developer,operator,user
        description: |
          Specify a subset of release-notes, which is published to the github release.
          By default, all audiences are included.
          Audiences are expected as a comma-separated list of values.
      github-release-notes-categories:
        required: false
        type: string
        default: action,breaking,bugfix,doc,feature,fix,improvement,noteworthy,other
        description: |
          Specify a subset of release-notes, which is published to the github release.
          By default, all categories are included.
          Categories are expected as a comma-separated list of values.
      github-release-notes-recursion-depth:
        required: false
        type: number
        default: 0
        description: |
          Sspecify a subset of release-notes, which is published to the github release.
          By default, no release-notes from subcomponents are included.

          Possible values:
          -1: no limit, include *all* subcomponents
           0: no sub components
           1: directly referenced subcomponents
           2: ...
      github-release-notes-resource-details:
        required: false
        type: boolean
        default: true
        description: |
          Whether to include resource details (e.g. OCI Image references, Helm Charts, ...).
      social-release-notes-audiences:
        required: false
        type: string
        default: dependency,developer,operator,user
        description: see partner input for details
      social-release-notes-categories:
        required: false
        type: string
        default: action,breaking,bugfix,doc,feature,fix,improvement,noteworthy,other
        description: see partner input for details
      social-release-notes-recursion-depth:
        required: false
        type: number
        default: 0
        description: see partner input for details
      social-release-notes-resource-details:
        required: false
        type: boolean
        default: true
        description: see partner input for details
      release-on-github:
        default: true
        type: boolean
        description: |
          If set to `true`, the workflow will create a new GitHub release (or convert an existing
          draft release to an actual release).
      github-tag-template:
        default: '${version}'
        type: string
        description: |
          GitHub tag template to use for the created release tag. Currently only supported
          template-var: ${version} (bash-syntax).
      github-additional-tag-templates:
        required: false
        type: string
        description: |
          Optional newline-separated list of additional tag templates. Each non-empty line will be
          treated like `github-tag-template` (supporting ${version} substitution) and an additional
          GitHub tag pointing to the release commit will be created. Empty or duplicate (already
          existing) tags are ignored.
      assets:
        type: string
        required: false
        description: |
          An optional list of release-assets in YAML-format that will be added to the GitHub-Release.
          If creation of github-release is suppressed (via `release-on-github` input), this value
          will be ignored.

          Each element is expected to have the following form:

          ```
          name: <name, as it should be set for the release-asset>, required
          mime-type: # optional (will be determined using libmagic, if absent)
          type: ocm-resource # mandatory; only `ocm-resource` is supported; for future extensions
          id:
            name: <ocm-resource-name>, required
            type: <ocm-resource-type>, optional
            <extra-id-attr>: <value> # optional - any attributes from extraIdentity
          ```

          `id` must be specified such that a resource is identified unambiguously. Only resources
          that are stored as a localBlob (access-type) are supported.

          Example (assuming pipeline builds `helm` for multiple platforms):
          ```
          assets: |
           - name: helm-linux-x86-64
             mime-type: application/x-pie-executable
             type: ocm-resource
             id:
              name: helm
              os: linux
              arch: x86_64
          ```
      version-read-callback:
        type: string
        required: false
        description: |
          passed to `version` action as `read-callback`. see this action for documentation
      version-write-callback:
        type: string
        required: false
        description: |
          passed to `version` action as `write-callback`. see this action for documentation
      version-versionfile:
        type: string
        required: false
        description: |
          passed to `version` action as `versionfile`. see this action for documentation
      include-subcomponent-release-notes:
        type: boolean
        default: false
        description: |
          passed as same-named input to release-notes action. Controls whether copies of
          release-notes of sub-components are included.
      create-release-branch:
        type: boolean
        default: false
        description: |
          controls whether a release-/hotfix-branch should be created for the current release.
          Honours the `.ocm/branch-info.yaml`'s `release-branch-template` setting if any, otherwise
          defaults to "release-v$major.$minor" as template.
      cleanup-release-branches:
        type: boolean
        default: false
        description: |
          controls whether stale release-/hotfix-branches should be automatically purged. A release
          branch is considered stale if its version (major, minor, or patch, according to
          `significant-part` in `.ocm/branch-info.yaml`) is older than the current version by at
          least the `supported-versions-count`.

    outputs:
      release-notes:
        description: |
          The release-notes accompanying this release (note that those will by default be
          published as part of component-descriptor, as well as via slack, if `slack-channel-id`
          input is specified).
        value: ${{ jobs.release-and-bump.outputs.release-notes }}
      component-descriptor:
        description: |
          The component-descriptor document, as it was uploaded during release
        value: ${{ jobs.release-and-bump.outputs.component-descriptor }}
      version:
        description: |
          The component-version (for convenience)
        value: ${{ jobs.release-and-bump.outputs.version }}
jobs:
  release-and-bump:
    runs-on: ${{ vars.DEFAULT_RUNNER || 'ubuntu-latest' }}
    permissions:
      contents: write
      packages: write
      id-token: write

    outputs:
      release-notes: ${{ steps.release-notes.outputs.release-notes }}
      component-descriptor: ${{ steps.release.outputs.component-descriptor }}
      version: ${{ steps.component-descriptor.outputs.version }}

    steps:
      - name: collect-component-descriptor
        id: component-descriptor
        uses: gardener/cc-utils/.github/actions/merge-ocm-fragments@master
        with:
          component-descriptor-artefact: base-component-descriptor
          component-descriptor: ${{ inputs.component-descriptor }}
          outdir: /tmp/ocm
      - name: fetch-prepare-values
        uses: gardener/cc-utils/.github/actions/download-artifact@master
        with:
          name: prepare-workflow-values
      - name: prepare-prepare-workflow-values
        id: prep
        run: |
          tar xf prepare-workflow-values.tar prepare-values.d/ocm-repositories
          ocm_repos="$(cat prepare-values.d/ocm-repositories)"
          rm -rf prepare-values.d prepare-workflow-values.tar
          echo "ocm-repositories=${ocm_repos}" >> ${GITHUB_OUTPUT}
      - name: checkout
        uses: actions/checkout@v6
      - name: prepare-next-version-operation
        id: prep-next-version
        shell: python
        run: |
          import os

          import yaml

          import ocm.branch_info


          next_version = '${{ inputs.next-version }}'

          if next_version != 'automatic':
            print(f'INFO: {next_version=} is not set to "automatic", no special handling needed')
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'next-version={next_version}\n')
            exit(0)

          if not os.path.isfile(branch_info_file := '.ocm/branch-info.yaml'):
            print(f'ERROR: Did not find {branch_info_file=} but next-version was set to "automatic"')
            exit(1)

          with open(branch_info_file) as f:
            branch_info_raw = yaml.safe_load(f)

          branch_info = ocm.branch_info.BranchInfo.from_dict(branch_info_raw)
          branch_policy = branch_info.branch_policy

          branch_name = '${{ github.ref_name }}'

          if branch_info.release_branch_pattern.fullmatch(branch_name):
            print(f'INFO: Running on release branch {branch_name}')

            if branch_policy.significant_part is ocm.branch_info.VersionParts.MAJOR:
              next_version = 'bump-minor'
            elif branch_policy.significant_part is ocm.branch_info.VersionParts.MINOR:
              next_version = 'bump-patch'
            elif branch_policy.significant_part is ocm.branch_info.VersionParts.PATCH:
              print(f'ERROR: Significant part is "patch", but no smaller part to bump')
              exit(1)
            else:
              print(f'ERROR: Unknown significant_part {branch_policy.significant_part}')
              exit(1)

          else:
            print(f'INFO: Running on non-release branch {branch_name}')

            if branch_policy.significant_part is ocm.branch_info.VersionParts.MAJOR:
              next_version = 'bump-major'
            elif branch_policy.significant_part is ocm.branch_info.VersionParts.MINOR:
              next_version = 'bump-minor'
            elif branch_policy.significant_part is ocm.branch_info.VersionParts.PATCH:
              next_version = 'bump-patch'
            else:
              print(f'ERROR: Unknown significant_part {branch_policy.significant_part}')
              exit(1)

          print(f'INFO: "automatic" version operation has been resolved to {next_version=}')
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'next-version={next_version}\n')
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.GARDENER_GITHUB_ACTIONS_APP_ID }}
          private-key: ${{ secrets.github-app-secret-key || secrets.GARDENER_GITHUB_ACTIONS_PRIVATE_KEY }}
      - uses: gardener/cc-utils/.github/actions/release-notes@master
        id: release-notes
        with:
          component-descriptor: ${{ steps.component-descriptor.outputs.component-descriptor }}
          ocm-repositories: ${{ steps.prep.outputs.ocm-repositories }}
          github-token: ${{ steps.app-token.outputs.token }}
          draft: false
          include-subcomponent-release-notes: ${{ inputs.include-subcomponent-release-notes }}
          release-notes-variants: |
            - name: github
              audiences: ${{ inputs.github-release-notes-audiences }}
              categories: ${{ inputs.github-release-notes-categories }}
              recursion_depth: ${{ inputs.github-release-notes-recursion-depth }}
              include_resources: ${{ inputs.github-release-notes-resource-details }}
            - name: slack
              audiences: ${{ inputs.social-release-notes-audiences }}
              categories: ${{ inputs.social-release-notes-categories }}
              recursion_depth: ${{ inputs.social-release-notes-recursion-depth }}
              include_resources: ${{ inputs.social-release-notes-resource-details }}
            - name: legacy
              audiences: ''
              categories: ''
              recursion_depth: 0
              include_resources: true
      - uses: gardener/cc-utils/.github/actions/release@master
        id: release
        with:
          component-descriptor: ${{ steps.component-descriptor.outputs.component-descriptor }}
          component-descriptor-blobs-dir: /tmp/ocm/blobs.d
          release-commit-objects: ${{ inputs.release-commit-objects }}
          release-commit-objects-artefact: release-commit-objects
          release-commit-target: ${{ inputs.release-commit-target }}
          next-version: ${{ steps.prep-next-version.outputs.next-version }}
          next-version-commit-message: "next version: ${version}"
          next-version-callback-action-path: ${{ inputs.next-version-callback-action-path }}
          on-validation-errors: ${{ inputs.on-validation-errors }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          git-push-token: ${{ steps.app-token.outputs.token }}
          release-on-github: ${{ inputs.release-on-github }}
          github-tag-template: ${{ inputs.github-tag-template }}
          github-additional-tag-templates: ${{ inputs.github-additional-tag-templates }}
          assets: ${{ inputs.assets }}
          version-read-callback: ${{ inputs.version-read-callback }}
          version-write-callback: ${{ inputs.version-write-callback }}
          version-versionfile: ${{ inputs.version-versionfile }}

      - name: publish-release-notes-to-slack
        if: ${{ inputs.slack-channel-id != '' }}
        uses: slackapi/slack-github-action@v2
        with:
          method: files.uploadV2
          token: ${{ secrets.slack-token || secrets.SLACK_APP_TOKEN_GARDENER_CICD }}
          payload: |
            channel_id: ${{ inputs.slack-channel-id }}
            title: '[${{ steps.component-descriptor.outputs.component-version }} released]'
            file: /tmp/release-notes/slack-release-notes.md

      - name: reset-repository-to-release-commit
        if: ${{ inputs.create-release-branch && steps.prep-next-version.outputs.next-version != 'bump-patch' }}
        shell: bash
        run: |
          set -euo pipefail

          # note: only works if capture-commit action was only used to create the release-commit
          commit_digest="$(git rev-parse refs/capture-commit)"

          git reset --hard "$commit_digest"

      - name: create-release-branch-bump-commit
        if: ${{ inputs.create-release-branch && steps.prep-next-version.outputs.next-version != 'bump-patch' }}
        uses: gardener/cc-utils/.github/actions/version@master
        # must be kept in sync with version action called in release action (except "version-operation")
        with:
          versionfile: ${{ inputs.version-versionfile }}
          read-callback: ${{ inputs.version-read-callback }}
          write-callback: ${{ inputs.version-write-callback }}
          callback-action-path: ${{ inputs.next-version-callback-action-path }}
          commit-message: "next version: ${version}"
          version-operation: bump-patch
          prerelease: dev
          repository-operation: commit-to-head
          commit-kind: bump

      - name: create-and-push-release-branch
        if: ${{ inputs.create-release-branch && steps.prep-next-version.outputs.next-version != 'bump-patch' }}
        shell: bash
        run: |
          set -euo pipefail

          version="${{ steps.component-descriptor.outputs.version }}"

          if [[ $version == v* ]]; then
            prefix="v"
            semver_version="${version#v}"
          else
            prefix=""
            semver_version="$version"
          fi

          export major=$(echo "$semver_version" | cut -d. -f1)
          export minor=$(echo "$semver_version" | cut -d. -f2)
          export patch=$(echo "$semver_version" | cut -d. -f3)

          # default values if not present in .ocm/branch-info.yaml file
          release_branch_template="release-v$major.$minor"

          if [ -f .ocm/branch-info.yaml ]; then
            release_branch_template_overwrite=$(cat .ocm/branch-info.yaml | yq .release-branch-template)

            if [ $release_branch_template_overwrite != "null" ]; then
              echo "INFO: Found .ocm/branch-info.yaml file with branch template $release_branch_template_overwrite"
              release_branch_template=$release_branch_template_overwrite
            fi
          fi

          branch="$(echo $release_branch_template | envsubst)" # fill in values of major/minor/patch

          git push origin "@:refs/heads/$branch"

      - name: cleanup-stale-release-branches
        if: ${{ inputs.cleanup-release-branches }}
        uses: gardener/cc-utils/.github/actions/cleanup-release-branches@master
        with:
          version: ${{ steps.component-descriptor.outputs.version }}
